name: PR Validation

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate-title:
    name: Check PR Title
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to comment
      contents: read
      issues: write

    steps:
      - name: Validate PR title format
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Must contain PRCTAX-<number>
            const pattern = PRCTAX-\d+;

            if (!pattern.test(title)) {
              const message = `
                Please update the PR' title to include the ticket number, at the beginning, with this format:
                \`PRCTAX-{number}\`
                `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message.trim(),
              });

              core.setFailed(
                `PR title "${title}" does not match required pattern [PRCTAX-{number}].`
              );
            } else {
              core.info(`PR title "${title}" matches required pattern.`);
            }

  auto-assign-author:
    name: Autoâ€‘assign PR to Author
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to assign
      contents: read
      issues: write

    steps:
      - name: Assign PR to author (best effort)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = pr.user.login;

            const assignees = (pr.assignees || []).map(a => a.login);
            if (assignees.includes(owner)) {
              core.info(`PR #${pr.number} is already assigned to @${owner}.`);
            } else {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                assignees: [owner],
              });
              core.info(`Assigned PR #${pr.number} to @${owner}.`);
            }

  validate-project:
    name: Check if a project is assigned
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      
    steps:
      - name: Ensure PR is assigned to at least one project
        env: 
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
           PR_NUM=${{ github.event.pull_request.number }}
          
            # Use gh pr view with --json to get project information
           COUNT=$(gh pr view ${{ github.event.pull_request.number }} \
              --repo ${{ github.repository }} \
              --json projectItems --jq '.projectItems | length')


           if [ "$COUNT" -eq 0 ]; then
             echo "::error::PR #$PR_NUM is not assigned to any Project v2 board."
             exit 1
           else
             echo "Success: PR is assigned to $COUNT project(s)."
           fi
