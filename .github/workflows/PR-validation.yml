name: Validate PR Title and Assign

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate-title-and-assign:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write    # needed to comment & assign
      contents: read

    steps:
      - name: Validate PR title format
        id: validate_title
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Must contain [PRCTAX-<number>] exactly
            const pattern = /\[PRCTAX-\d+\]/;

            if (!pattern.test(title)) {
              const message = `
                This pull request title does not match the required format:
                \`[PRCTAX-{number}] Some description\`
                `;

              // Post comment to PR
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message.trim(),
              });
              core.setOutput('failed', 'true');
              core.setFailed(
                `PR title "${title}" does not match required pattern [PRCTAX-{number}].`
              );
            } else {
              core.setOutput('failed', 'false');
              core.info(`PR title "${title}" matches required pattern.`);
            }

      - name: Record title validation result
        id: record_title
        run: |
          echo "title_failed=${{ steps.validate_title.outputs.failed }}" >> $GITHUB_OUTPUT

      - name: Assign PR to author
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = pr.user.login;

            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              assignees: [owner],
            });

            core.info(`Assigned PR #${pr.number} to @${owner}.`);
            
      - name: Ensure PR is assigned to at least one project
        id: validate_project
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // For Projects v2, check linked project items via GraphQL
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    id
                    projectsV2(first: 5) {
                      nodes {
                        id
                        title
                      }
                    }
                    projectItems(first: 5) {
                      nodes {
                        id
                        project {
                          name
                        }
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              prNumber: pr.number,
            };

            const result = await github.graphql(query, variables);

            const prData = result.repository.pullRequest;

            const projectsV2 = prData.projectsV2?.nodes || [];
            const projectItems = prData.projectItems?.nodes || [];

            const hasAnyProject =
              (projectsV2 && projectsV2.length > 0) ||
              (projectItems && projectItems.length > 0);

            if (!hasAnyProject) {
              const message = `
                This pull request is **not currently assigned to any project**.
                Once a project is assigned, re-run the validation.`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message.trim(),
              });
              core.setOutput('failed', 'true');
              core.setFailed(
                'PR is not assigned to any project.'
              );
            } else {
              const projectNames = [
                ...projectsV2.map(p => p.title),
                ...projectItems
                  .map(p => p.project && p.project.name)
                  .filter(Boolean),
              ];
              core.info(
                `PR is linked to project(s): ${projectNames.join(', ') || '(names unavailable)'}`
              );
              core.setOutput('failed', 'false');
            }
      - name: Record project validation result
        id: record_project
        run: |
          echo "project_failed=${{ steps.validate_project.outputs.failed }}" >> $GITHUB_OUTPUT

      - name: Final gate â€“ fail job if any validation failed
        run: |
          echo "Title failed:   ${{ steps.record_title.outputs.title_failed }}"
          echo "Project failed: ${{ steps.record_project.outputs.project_failed }}"

          FAILED=0

          if [ "${{ steps.record_title.outputs.title_failed }}" = "true" ]; then
            FAILED=1
          fi

          if [ "${{ steps.record_project.outputs.project_failed }}" = "true" ]; then
            FAILED=1
          fi

          if [ "$FAILED" -ne 0 ]; then
            echo "One or more validations failed. Failing job to block merge."
            exit 1
          else
            echo "All validations passed."
          fi
