name: PR Validation

on:
  pull_request:
    types: [opened, edited, reopened, synchronize]

jobs:
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to comment
      contents: read
      issues: write

    steps:
      - name: Validate PR title format
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;

            // Must contain [PRCTAX-<number>]
            const pattern = /\[PRCTAX-\d+\]/;

            if (!pattern.test(title)) {
              const message = `
                Please update the PR' title to include the ticket number, at the beginning, with this format:
                \`[PRCTAX-{number}]\`
                `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message.trim(),
              });

              core.setFailed(
                `PR title "${title}" does not match required pattern [PRCTAX-{number}].`
              );
            } else {
              core.info(`PR title "${title}" matches required pattern.`);
            }

  auto-assign-author:
    name: Autoâ€‘assign PR to Author
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to assign
      contents: read
      issues: write

    steps:
      - name: Assign PR to author (best effort)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const owner = pr.user.login;

            const assignees = (pr.assignees || []).map(a => a.login);
            if (assignees.includes(owner)) {
              core.info(`PR #${pr.number} is already assigned to @${owner}.`);
            } else {
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                assignees: [owner],
              });
              core.info(`Assigned PR #${pr.number} to @${owner}.`);
            }

  validate-project:
    name: Validate Project Assignment
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write   # to comment
      contents: read
      issues: write

    steps:
      - name: Ensure PR is assigned to at least one project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // Supports both Projects v2 and classic projects
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    projectsV2(first: 5) {
                      nodes {
                        id
                        title
                      }
                    }
                  }
                }
              }
            `;

            const variables = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              prNumber: pr.number,
            };

            const result = await github.graphql(query, variables);

            const prData = result.repository.pullRequest;

            const projectsV2 = (prData.projectsV2 && prData.projectsV2.nodes) || [];

            const hasAnyProject = projectsV2 && projectsV2.length > 0

            if (!hasAnyProject) {
              const message = `
                This pull request is **not currently assigned to any project**.

                Please link this PR to an appropriate GitHub Project (via the Projects sidebar)
                before merging.
                Once a project is assigned, re-run this check
              `;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: message.trim(),
              });

              core.setFailed(
                'PR is not assigned to any project (Projects v2 or classic project items).'
              );
            }
